---
layout: post
title: React Hooksæ—©çŸ¥é“
categories: [React, javascript]
tags: [React, javascript]
fullview: true
comments: true
---

ä½œè€…ï¼šdocoder@[æ¯›è±†å‰ç«¯](https://maodoufe.github.io/)
## React Hooks

### Notes

- Example

  ```jsx
  function Example() {
    const [count, setCount] = useState(0);
    useEffect(() => {
      document.title = `ç‚¹å‡»äº† ${count} æ¬¡`;
    });
    return (
      <div>
        <p>ç‚¹å‡»äº† {count} æ¬¡</p>
        <button onClick={() => setCount(count + 1)}>
          ç‚¹å‡»
        </button>
      </div>
    );
  }
  ```

 - React 16.8

- No Breaking Changes
  - å¯é€‰çš„
  - 100% å‘åå…¼å®¹
  - ç«‹å³å¯ç”¨

- Class ä¸ä¼šè¢«ç§»é™¤

- Hook è¢« React å›¢é˜Ÿ æœŸæœ›æˆä¸ºæœªæ¥å†™ React çš„ä¸»è¦æ–¹å¼

- é™¤äº†ä¸å¸¸ç”¨çš„ getDerivedStateFromError å’Œ componentDidCatch åœ¨ hook ä¸­è¿˜æ²¡æœ‰è¢«ç­‰ä»·å®ç°ï¼ˆå¾ˆå¿«ä¼šæ·»åŠ ï¼‰ï¼Œå…¶ä»–å‡ ä¹å¯ä»¥è¦†ç›–æ‰€æœ‰ä½¿ç”¨ Class çš„æƒ…å†µ

- ä¸å½±å“å¯¹Reactçš„ç†è§£

- æœªæ¥ Redux connect() å’Œ React Router ä¹Ÿä¼šä½¿ç”¨ç±»ä¼¼ useRedux() æˆ– useRouter() çš„è‡ªå®šä¹‰ Hooksï¼Œå½“ç„¶ç°åœ¨çš„ API ç”¨æ³•ä¹Ÿæ˜¯å…¼å®¹çš„

- å¯¹é™æ€ç±»å‹æ”¯æŒæ›´å¥½ï¼Œå¦‚ TypeScript

- æ€§èƒ½æ›´å¥½

  - é¿å…äº† Class çš„å¼€é”€
  - é‡ç”¨é€»è¾‘æ— éœ€é«˜é˜¶ç»„ä»¶ï¼Œå‡å°‘å±‚çº§

- **é€»è¾‘é‡ç”¨**

  - ~~render props~~
  - ~~é«˜é˜¶ç»„ä»¶~~
  - é‡æ„ï¼ŒæŠ½å–é€šç”¨é€»è¾‘ï¼Œä¸ç”¨é‡å†™å±‚çº§ç»“æ„

- **æ‹¥æŠ± function, æ—  Class**

  - class ç¼ºé™·
  - this
  - [syntax proposals](https://babeljs.io/docs/en/babel-plugin-transform-class-properties/)
  - function or  class compnents
  - AOT
  - minify

- **Thinking in Hooks**

- ä¸èƒ½åœ¨ Class ä¸­ä½¿ç”¨

- åˆ›å»ºè‡ªå·±çš„ Hooks

  - æ¯ä¸€æ¬¡è°ƒç”¨éƒ½ä¼šå¾—åˆ°ä¸€ä¸ªå®Œå…¨å­¤ç«‹çš„çŠ¶æ€
  - å¯ä»¥åœ¨åŒä¸€ä¸ªç»„ä»¶ä¸­ä½¿ç”¨ä¸¤æ¬¡ç›¸åŒçš„è‡ªå®šä¹‰ Hook
  - çº¦å®šå¤§äºç‰¹æ€§
    - ä»¥ "use" å¼€å¤´
      - åªç”¨äº linter plugin
      - react å¹¶æ²¡æœ‰ä¾èµ–æ­¤æ¥æœç´¢ hook æˆ–å®Œæˆå…¶ä»–åŠŸèƒ½ç‰¹æ€§ 

- **Hook è®©æˆ‘ä»¬æ ¹æ®ä»£ç çš„ä½œç”¨è¿›è¡Œæ‹†åˆ†**

  - å¤šæ¬¡ä½¿ç”¨ï¼Œç²’åº¦æ›´å°

- Hooks åªèƒ½åœ¨**é¡¶å±‚**è°ƒç”¨

  - ä¸èƒ½åœ¨å¾ªç¯ï¼Œæ¡ä»¶è¯­å¥ï¼ŒåµŒå¥—å‡½æ•°ä¸­è°ƒç”¨

  - ä¿è¯å…¶é¡ºåºæ€§å’Œæ­£ç¡®æ€§

    - ä¿è¯æ¯æ¬¡ render éƒ½æŒ‰åŒæ ·çš„é¡ºåºæ‰§è¡Œ

    - åœ¨å¤šä¸ª useState å’Œ useEffect è°ƒç”¨è¿‡ç¨‹ä¸­ä¿è¯ state çš„æ­£ç¡®æ€§

    - React ä¾èµ– Hooks çš„è°ƒç”¨é¡ºåºæ¥ç¡®ä¿ state å’Œ useState çš„å¯¹åº”

      - é€šè¿‡ç±»ä¼¼æ•°ç»„çš„æ–¹å¼å®ç°ï¼Œæ¯æ¬¡ render æ˜¯æŒ‰æ•°ç»„ index è¿›è¡Œå¯¹åº”

      ```js
      // ------------
      // First render
      // ------------
      useState('Mary')           // 1. Initialize the name state variable with 'Mary'
      useEffect(persistForm)     // 2. Add an effect for persisting the form
      useState('Poppins')        // 3. Initialize the surname state variable with 'Poppins'
      useEffect(updateTitle)     // 4. Add an effect for updating the title
      
      // -------------
      // Second render
      // -------------
      useState('Mary')           // 1. Read the name state variable (argument is ignored)
      useEffect(persistForm)     // 2. Replace the effect for persisting the form
      useState('Poppins')        // 3. Read the surname state variable (argument is ignored)
      useEffect(updateTitle)     // 4. Replace the effect for updating the title
      
      // ...
      ```

      

  - linter plugin ä¼šè¿›è¡ŒéªŒè¯

- åªèƒ½åœ¨ React functions ä¸­è°ƒç”¨ï¼Œ ä¸èƒ½åœ¨æ™®é€šçš„ JavaScript å‡½æ•°ä¸­è°ƒç”¨

  -  React çš„å‡½æ•°å¼ç»„ä»¶
  - è‡ªå®šä¹‰çš„ Hook 

- linter plugin

  - [`eslint-plugin-react-hooks`](https://www.npmjs.com/package/eslint-plugin-react-hooks)
  - Create React App 

- shouldComponentUpdate

  - React .memo wrap ä¸€ä¸ª function component ä¼šæµ…æ¯”è¾ƒ props

    - ä»…æ¯”è¾ƒå±æ€§ï¼Œå› ä¸ºä¸å­˜åœ¨ single state object to compare
    - ç¬¬äºŒä¸ªå‚æ•°æ¥æ”¶ä¸€ä¸ªè‡ªå®šä¹‰çš„ comparison function
    - è¿”å› trueï¼Œupdate å°†è¢«è·³è¿‡

    ```jsx
    const Button = React.memo((props) => {
      // your component
    });
    ```

  - useMemo

- getDerivedStateFromProps

  ```js
  function ScrollView({row}) {
    let [isScrollingDown, setIsScrollingDown] = useState(false);
    let [prevRow, setPrevRow] = useState(null);
  
    if (row !== prevRow) {
      // Row changed since last render. Update isScrollingDown.
      setIsScrollingDown(prevRow !== null && row > prevRow);
      setPrevRow(row);
    }
  
    return `Scrolling down: ${isScrollingDown}`;
  }
  ```

  â€‹    

### Hooks

- state hook

  - useState

    ```js
    const [state, setState] = useState(initialState);
    ```

  - å¤šä¸ªStateï¼Œå¤šæ¬¡ä½¿ç”¨useState

    - æ•°ç»„è§£æ„ï¼Œèµ‹äºˆçŠ¶æ€å˜é‡ä¸åŒçš„åå­—

    - åœ¨æ¯ä¸€æ¬¡æ¸²æŸ“ä¸­ä»¥ç›¸åŒçš„é¡ºåºè¢«è°ƒç”¨

    - initialState ä¸å¿…é¡»æ˜¯å¯¹è±¡ï¼Œå®é™…ä¸Šä¸é¼“åŠ±æ˜¯å¯¹è±¡ï¼Œæ ¹æ®å®é™…æ•°æ®ç›¸å…³æ€§ï¼Œè¿›è¡Œåˆ†ç»„å’Œåˆ†ç¦»ã€‚è¿™æ ·ä¹Ÿæ›´åˆ©äºä¹‹åä»£ç é‡æ„ï¼ŒæŠ½å–ç›¸å…³é€»è¾‘æˆä¸€ä¸ªè‡ªå®šä¹‰ Hook

      ```jsx
      //ğŸ‘
      const [state, setState] = useState({ left: 0, top: 0, width: 100, height: 100 });
      
      //ğŸ‘æ”¹ä¸ºå¦‚ä¸‹ï¼š
      const [position, setPosition] = useState({ left: 0, top: 0 });
      const [size, setSize] = useState({ width: 100, height: 100 });
      
      //é‡æ„ï¼Œè‡ªå®šä¹‰ Hook:
      function Box() {
        const position = useWindowPosition();
        const [size, setSize] = useState({ width: 100, height: 100 });
        // ...
      }
      
      function useWindowPosition() {
        const [position, setPosition] = useState({ left: 0, top: 0 });
        useEffect(() => {
          // ...
        }, []);
        return position;
      }
      ```

      

  - state ä»…åœ¨ç¬¬ä¸€æ¬¡ render æ—¶è¢«åˆ›å»ºï¼Œä¹‹ååªæ˜¯ä¿®æ”¹ä½¿æˆ‘ä»¬å¾—åˆ°æœ€æ–°çš„ state

  - æ— éœ€åƒ useEffect æˆ– useCallback é‚£æ ·æŒ‡å®š ä¾èµ–åˆ—è¡¨ï¼Œç”± React æ¥ä¿è¯

    - æœªæ¥ï¼ŒReactä¹Ÿä¼šç§»é™¤ useEffect å’Œ useCallback çš„ä¾èµ–åˆ—è¡¨ï¼Œå› ä¸ºè¿™å®Œå…¨å¯ä»¥é€šè¿‡ç®—æ³•è‡ªåŠ¨è§£å†³

  - å‡½æ•°å¼æ›´æ–° (Functional updates)

    - æ–°å€¼æ˜¯é€šè¿‡ä¹‹å‰çš„å€¼è®¡ç®—è€Œæ¥

    - setCount å¯ä»¥æ¥å—ä¸€ä¸ªå‡½æ•°ï¼Œæ¥å—ä¹‹å‰çš„ stateï¼Œ è¿”å›æ–°çš„ state

      ```jsx
      function Counter({initialCount}) {
        const [count, setCount] = useState(initialCount);
        return (
          <>
            Count: {count}
            <button onClick={() => setCount(initialCount)}>Reset</button>
            <button onClick={() => setCount(prevCount => prevCount + 1)}>+</button>
            <button onClick={() => setCount(prevCount => prevCount - 1)}>-</button>
          </>
        );
      }
      ```

  - state æ›´æ–°äº†ç›¸åŒçš„å€¼ï¼Œä¸ä¼šè¿›è¡Œ render æˆ– è§¦å‘ effect

    - Object.is() ç®—æ³•ï¼Œè¿›è¡Œæ¯”è¾ƒ

    - useMemo

    - forceUpdate ?

      - é¿å…ä½¿ç”¨

      - hack

        ```js
        const [ignored, forceUpdate] = useReducer(x => x + 1, 0);
        
        function handleClick() {
          forceUpdate();
        }
        ```

  - æ‡’åˆå§‹åŒ–

    - useState æ¥å—ä¸€ä¸ªå‡½æ•°ï¼Œè¿”å› initialStateï¼Œä»…å½“åˆå§‹ render æ—¶è¢«è°ƒç”¨è¿›è¡Œåˆå§‹åŒ–ï¼Œåªè°ƒç”¨ä¸€æ¬¡

      ```jsx
      const [state, setState] = useState(() => {
        const initialState = someExpensiveComputation(props);
        return initialState;
      });
      ```

      

- effect hook

  - useEffect

    ```js
    useEffect(
      () => {
        // side effects (è·å–æ•°æ®ã€è®¾ç½®è®¢é˜…å’Œæ‰‹åŠ¨æ›´æ”¹ React ç»„ä»¶ä¸­çš„ DOM ç­‰)
        return () => { // å¯é€‰
          // clean up
        }
      }
     	,
      [state, ...] // å¯é€‰ï¼Œä»…å½“ state (æˆ– ...) æ”¹å˜æ—¶ï¼Œeffect æ‰é‡æ–°è¿è¡Œ
    );
    ```

  - å°†ç±»ç»„ä»¶ä¸­çš„ `componentDidMount` ï¼Œ`componentDidUpdate`å’Œ `componentWillUnmount` ç»Ÿä¸€ä¸ºä¸€ä¸ª API

    - é¿å…é€»è¾‘åˆ†æ•£å’Œé‡å¤ä¹¦å†™
      - ç”Ÿå‘½å‘¨æœŸå‡½æ•°å¸¸å¸¸åŒ…å«ä¸ç›¸å…³çš„é€»è¾‘ï¼ŒåŒæ—¶ç›¸å…³çš„é€»è¾‘è¢«æ‹†åˆ†è¿›ä¸åŒçš„æ–¹æ³•

  - åœ¨æ¯ä¸€æ¬¡ render åè¿è¡Œ effects ( åŒ…æ‹¬ç¬¬ä¸€æ¬¡ render )

    - React ä¿è¯æ¯æ¬¡è¿è¡Œ effects ä¹‹å‰ DOM å·²ç»æ›´æ–°äº†
    - åœ¨æ¯æ¬¡ render çš„æ—¶å€™ï¼Œéƒ½æ˜¯æ–°åˆ›å»ºäº†ä¸€ä¸ªå‡½æ•°ä¼ é€’ç»™äº† `useEffect` 
      - æ¯æ¬¡éƒ½æ˜¯åˆ›å»ºäº†æ–°çš„ effect æ›¿æ¢ä¹‹å‰çš„ã€‚
      - æ¯ä¸ª effect å±äºä¸€ä¸ªç‰¹å®šçš„ render
      - ä¸ç”¨æ‹…å¿ƒ effect é‡Œ state è¿‡æœŸçš„é—®é¢˜

  - æ‹¥æŠ±é—­åŒ…ï¼Œåœ¨å‡½æ•°ä½œç”¨åŸŸä¸­ï¼Œå¯æ–¹ä¾¿è®¿é—® state

  - é€šè¿‡è¿”å›ä¸€ä¸ªå‡½æ•°æ¥ clean up

    - æ·»åŠ å’Œæ¸…ç†çš„é€»è¾‘å¯ä»¥å½¼æ­¤é è¿‘

    - åœ¨ä¸‹æ¬¡è¿è¡Œ effect ä¹‹å‰æ¸…ç†ä¸Šä¸€æ¬¡ render ä¸­çš„ effect

      - æ¸…ç†ä¸åœ¨ unmount è°ƒç”¨ä¸€æ¬¡ï¼Œè€Œæ˜¯åœ¨æ¯æ¬¡ re-render åè°ƒç”¨

        - é¿å…åœ¨ç¼ºå¤± `componentDidUpdate` æ—¶ä¼šäº§ç”Ÿçš„ bugs

          ```js
          //å½“ friend çš„å±æ€§æ”¹å˜æ—¶ï¼Œä¼šäº§ç”Ÿä¾æ—§æ˜¾ç¤ºä¹‹å‰ friend çš„åœ¨çº¿çŠ¶æ€çš„bugï¼Œå°¤å…¶å½“ unmounting çš„æ—¶å€™ï¼Œç”±äº unsubscribe ä¸€ä¸ªé”™è¯¯çš„ friend id ä¼šäº§ç”Ÿå†…å­˜æ³„éœ²ç”šè‡³ crash
          	componentDidMount() {
              ChatAPI.subscribeToFriendStatus(
                this.props.friend.id,
                this.handleStatusChange
              );
            }
          
          	componentWillUnmount() {
              ChatAPI.unsubscribeFromFriendStatus(
                this.props.friend.id,
                this.handleStatusChange
              );
            }
          ```

          ```js
          //éœ€è¦ä½¿ç”¨ componentDidUpdate
          	componentDidMount() {
              ChatAPI.subscribeToFriendStatus(
                this.props.friend.id,
                this.handleStatusChange
              );
            }
          
            componentDidUpdate(prevProps) {
              // Unsubscribe ä¹‹å‰çš„ friend.id
              ChatAPI.unsubscribeFromFriendStatus(
                prevProps.friend.id,
                this.handleStatusChange
              );
              // Subscribe æ–°çš„ friend.id
              ChatAPI.subscribeToFriendStatus(
                this.props.friend.id,
                this.handleStatusChange
              );
            }
          
            componentWillUnmount() {
              ChatAPI.unsubscribeFromFriendStatus(
                this.props.friend.id,
                this.handleStatusChange
              );
            }
          
          ```

      - å¯ä»¥æœ‰é€‰æ‹©çš„è¿è¡Œ effectï¼Œä»è€Œé¿å…æ€§èƒ½é—®é¢˜

        - useEffect çš„ç¬¬äºŒä¸ªå‚æ•°

          ```js
          useEffect(() => {
            function handleStatusChange(status) {
              setIsOnline(status.isOnline);
            }
          
            ChatAPI.subscribeToFriendStatus(props.friend.id, handleStatusChange);
            return () => {
              ChatAPI.unsubscribeFromFriendStatus(props.friend.id, handleStatusChange);
            };
          }, [props.friend.id]); // ä»…å½“ props.friend.id æ”¹å˜æ—¶ effect æ‰è¿è¡Œ
          ```

        - ä»…åœ¨ mount å’Œ unmount æ‰è¿è¡Œ effect

          - ç¬¬äºŒä¸ªå‚æ•°ä¼ ç©ºæ•°ç»„ `[]`

        - é”™è¯¯çš„æŒ‡å®šç¬¬äºŒä¸ªå‚æ•°(ç»å¸¸æ˜¯æŒ‡è¿‡å°‘é…ç½®), ä¼šé€ æˆå¾—ä¸åˆ°æœ€æ–°çš„ props æˆ– state çš„ bug

      - æŠŠå‡½æ•°æ”¾åˆ° useEffect é‡Œ, è¿™æ ·æ›´å®‰å…¨

        ```jsx
        function Example({ someProp }) {
          function doSomething() {
            console.log(someProp);
          }
        
          useEffect(() => {
            doSomething();
          }, []); // ğŸ”´ This is not safe (it calls `doSomething` which uses `someProp`)
        }
        ```

        ```jsx
        function Example({ someProp }) {
          useEffect(() => {
            function doSomething() {
              console.log(someProp);
            }
        
            doSomething();
          }, [someProp]); // âœ… OK (our effect only uses `someProp`)
        }
        
        function Example({ someProp }) {
          useEffect(() => {
            function doSomething() {
              console.log('hello');
            }
        
            doSomething();
          }, []); // âœ… OK in this example because we don't use *any* values from component scope
        }
        ```

      - ä¸èƒ½å°†å‡½æ•°æ”¾åˆ° effect é‡Œ

        - ç¡®ä¿å‡½æ•°ä¸­æ²¡æœ‰å¼•ç”¨ props æˆ– state

        - çº¯è®¡ç®—å‡½æ•°ï¼Œå°†è¯¥å‡½æ•°è¿”å›ç»“æœä½œä¸º effect çš„ä¾èµ–

        - ç”¨ useCallback wrap å‡½æ•° (ç¡®ä¿å‡½æ•°åœ¨ä¾èµ–ä¸å˜çš„æƒ…å†µä¸‹ï¼Œæœ¬èº«ä¸å˜)ï¼Œå†ä½œä¸º effect ä¾èµ–

          ```jsx
          function ProductPage({ productId }) {
            // âœ… Wrap with useCallback to avoid change on every render
            const fetchProduct = useCallback(() => {
              // ... Does something with productId ...
            }, [productId]); // âœ… All useCallback dependencies are specified
          
            return <ProductDetails fetchProduct={fetchProduct} />;
          }
          
          function ProductDetails({ fetchProduct })
            useEffect(() => {
              fetchProduct();
            }, [fetchProduct]); // âœ… All useEffect dependencies are specified
            // ...
          }
          ```

      - effect ä¾èµ–å˜åŠ¨å¤ªé¢‘ç¹

        - å‡½æ•°å¼æ›´æ–° (Functional updates)

        ```jsx
        function Counter() {
          const [count, setCount] = useState(0);
        
          useEffect(() => {
            const id = setInterval(() => {
              setCount(count + 1); // This effect depends on the `count` state
            }, 1000);
            return () => clearInterval(id);
          }, []); // ğŸ”´ Bug: `count` is not specified as a dependency
        
          return <h1>{count}</h1>;
        }
        ```

        ```jsx
        function Counter() {
          const [count, setCount] = useState(0);
        
          useEffect(() => {
            const id = setInterval(() => {
              setCount(c => c + 1); // âœ… This doesn't depend on `count` variable outside. The identity of the setCount function is guaranteed to be stable so itâ€™s safe to omit.
            }, 1000);
            return () => clearInterval(id);
          }, []); // âœ… Our effect doesn't use any variables in the component scope
        
          return <h1>{count}</h1>;
        }
        ```

        - [ä½¿ç”¨ useReducer ç®€åŒ– state çš„ç®¡ç†](https://adamrackis.dev/state-and-use-reducer/)

        ```jsx
        const BookEntryList = props => {
          const [pending, setPending] = useState(0);
          const [booksJustSaved, setBooksJustSaved] = useState([]);
        
          useEffect(() => {
            const ws = new WebSocket(webSocketAddress("/bookEntryWS"));
        
            ws.onmessage = ({ data }) => {
              let packet = JSON.parse(data);
              if (packet._messageType == "initial") {
                setPending(packet.pending);
              } else if (packet._messageType == "bookAdded") {
                setPending(pending - 1 || 0);
                setBooksJustSaved([packet, ...booksJustSaved]);
              } else if (packet._messageType == "pendingBookAdded") {
                setPending(+pending + 1 || 0);
              } else if (packet._messageType == "bookLookupFailed") {
                setPending(pending - 1 || 0);
                setBooksJustSaved([
                  {
                    _id: "" + new Date(),
                    title: `Failed lookup for ${packet.isbn}`,
                    success: false
                  },
                  ...booksJustSaved
                ]);
              }
            };
            return () => {
              try {
                ws.close();
              } catch (e) {}
            };
          }, []);
        
          //...
        };
        ```

        ```jsx
        function scanReducer(state, [type, payload]) {
          switch (type) {
            case "initial":
              return { ...state, pending: payload.pending };
            case "pendingBookAdded":
              return { ...state, pending: state.pending + 1 };
            case "bookAdded":
              return {
                ...state,
                pending: state.pending - 1,
                booksSaved: [payload, ...state.booksSaved]
              };
            case "bookLookupFailed":
              return {
                ...state,
                pending: state.pending - 1,
                booksSaved: [
                  {
                    _id: "" + new Date(),
                    title: `Failed lookup for ${payload.isbn}`,
                    success: false
                  },
                  ...state.booksSaved
                ]
              };
          }
          return state;
        }
        const initialState = { pending: 0, booksSaved: [] };
        
        const BookEntryList = props => {
          const [state, dispatch] = useReducer(scanReducer, initialState);
        
          useEffect(() => {
            const ws = new WebSocket(webSocketAddress("/bookEntryWS"));
        
            ws.onmessage = ({ data }) => {
              let packet = JSON.parse(data);
              dispatch([packet._messageType, packet]); // The identity of the dispatch function from useReducer is always stable
            };
            return () => {
              try {
                ws.close();
              } catch (e) {}
            };
          }, []);
        
          //...
        };
        ```

      - [`exhaustive-deps`](https://github.com/facebook/react/issues/14920) ESLint

        - [`eslint-plugin-react-hooks`](https://www.npmjs.com/package/eslint-plugin-react-hooks) ä¸­çš„ä¸€éƒ¨åˆ†
        - ç”¨æ¥éªŒè¯å¯¹äºç¬¬äºŒä¸ªå‚æ•°è¿›è¡Œä¸æ­£ç¡®çš„è®¾ç½®

  - [å¼‚æ­¥è¯·æ±‚æ•°æ®](https://www.robinwieruch.de/react-hooks-fetch-data/) 

    ```jsx
    function SearchResults() {
      const [data, setData] = useState({ hits: [] });
      const [query, setQuery] = useState('react');
    
      useEffect(() => { // åœ¨ useEffect é‡Œç›´æ¥ä½¿ç”¨ async function æ˜¯ä¸è¢«å…è®¸çš„ï¼Œå› ä¸º useEffect function å¿…é¡»è¦è¿”å›ä¸€ä¸ªæ¸…ç† function æˆ– nothingã€‚
        let ignore = false;
    
        async function fetchData() { //éœ€è¦åœ¨ useEffect function é‡Œä½¿ç”¨ async function
          const result = await axios('https://hn.algolia.com/api/v1/search?query=' + query);
          if (!ignore) setData(result.data); //å½“ç»„ä»¶ unmount æ—¶ï¼Œé˜»æ­¢å…¶è®¾ç½® state
        }
    
        fetchData();
        return () => { ignore = true; }
      }, [query]); // [query] é˜»æ­¢é€ æˆå¾ªç¯ï¼Œä»…å½“ query æ”¹å˜æ—¶ï¼Œeffect æ‰æ‰§è¡Œ
    
      return (
        <>
          <input value={query} onChange={e => setQuery(e.target.value)} />
          <ul>
            {data.hits.map(item => (
              <li key={item.objectID}>
                <a href={item.url}>{item.title}</a>
              </li>
            ))}
          </ul>
        </>
      );
    }
    ```

  - å…³æ³¨ç‚¹åˆ†ç¦»ï¼Œå¤šæ¬¡ä½¿ç”¨ useEffect

    - æ ¹æ®ä»£ç çš„ä½œç”¨æ‹†åˆ†æˆå¤šä¸ª effect

  - useEffect ä¸ä¼šé˜»å¡æµè§ˆå™¨æ¸²æŸ“

    - `componentDidMount` æˆ–`componentDidUpdate ` ä¼šé˜»å¡
    - æä¾›é˜»å¡ç‰ˆæœ¬ useLayoutEffect ï¼Œæ¥æ»¡è¶³åŒæ­¥è°ƒç”¨è®¡ç®—å…ƒç´ å°ºå¯¸ç­‰é—®é¢˜

- other hooks

  - useContext

  - useReducer

    - åªæ˜¯å¯¹ local state è¿›è¡Œ redux åŒ–ï¼Œæ²¡æœ‰å½¢æˆ store å’Œ å…¬ç”¨çš„ state æ ‘

    ```jsx
    const [state, dispatch] = useReducer(reducer, initialArg, init);
    ```

    ```jsx
    const initialState = {count: 0};
    
    function reducer(state, action) {
      switch (action.type) {
        case 'increment':
          return {count: state.count + 1};
        case 'decrement':
          return {count: state.count - 1};
        default:
          throw new Error();
      }
    }
    
    function Counter({initialState}) {
      const [state, dispatch] = useReducer(reducer, initialState);
      return (
        <>
          Count: {state.count}
          <button onClick={() => dispatch({type: 'increment'})}>+</button>
          <button onClick={() => dispatch({type: 'decrement'})}>-</button>
        </>
      );
    }
    ```
    - Pass down a dispatch function
    ```jsx
    const TodosDispatch = React.createContext(null);

    function TodosApp() {
      // Note: `dispatch` won't change between re-renders
        const [todos, dispatch] = useReducer(todosReducer);

        return (
            <TodosDispatch.Provider value={dispatch}>
                <DeepTree todos={todos} />
            </TodosDispatch.Provider>
        );
    }
    ```
    ```jsx

    function DeepChild(props) {
      // If we want to perform an action, we can get dispatch from context.
        const dispatch = useContext(TodosDispatch);

        function handleClick() {
            dispatch({ type: 'add', text: 'hello' });
        }

        return (
            <button onClick={handleClick}>Add todo</button>
        );
    }
    ```

    

  - useRef

    - ç±»ä¼¼å®ä¾‹å˜é‡

      ```jsx
      function Timer() {
        const intervalRef = useRef();
      
        useEffect(() => {
          const id = setInterval(() => {
            // ...
          });
          intervalRef.current = id; // current å¯ä»¥è¢«èµ‹ä»»ä½•å€¼ï¼Œç±»ä¼¼ç±»ä¸­çš„å®ä¾‹å˜é‡
          return () => {
            clearInterval(intervalRef.current);
          };
        });
      
        // ...
        function handleCancelClick() {
          clearInterval(intervalRef.current);
        }
        // ...
      }
      ```

    - è·å– previous state

      ```jsx
      function Counter() {
        const [count, setCount] = useState(0);
        const prevCountRef = useRef();
        useEffect(() => {
          prevCountRef.current = count;
        });
        const prevCount = prevCountRef.current;
      
        return <h1>Now: {count}, before: {prevCount}</h1>;
      }
      ```

    - è‡ªå®šä¹‰ Hookï¼ŒusePrevious

      - å¯èƒ½ä¹‹åä¼šæä¾›å¼€ç®±å³ç”¨çš„å®˜æ–¹å®ç°

      ```jsx
      function Counter() {
        const [count, setCount] = useState(0);
        const prevCount = usePrevious(count); // ä½¿ç”¨è‡ªå®šä¹‰çš„ Hook
        return <h1>Now: {count}, before: {prevCount}</h1>;
      }
      // è‡ªå®šä¹‰ Hook
      function usePrevious(value) {
        const ref = useRef();
        useEffect(() => {
          ref.current = value;
        });
        return ref.current;
      }
      ```

    - åœ¨ä¸€äº›å¼‚æ­¥å›æ‰ä¸­ï¼Œè¯»å–æœ€æ–° state 

      ```jsx
      // é¦–å…ˆç‚¹å‡» Show alert, ç„¶åç‚¹å‡» Click me
      function Example() {
        const [count, setCount] = useState(0);
      
        function handleAlertClick() {
          setTimeout(() => {
            alert('You clicked on: ' + count); //è¯»å–çš„æ˜¯ç‚¹å‡» Show alert æ—¶çš„ countï¼Œä¸æ˜¯æœ€æ–°å€¼
          }, 3000);
        }
      
        return (
          <div>
            <p>You clicked {count} times</p>
            <button onClick={() => setCount(count + 1)}>
              Click me
            </button>
            <button onClick={handleAlertClick}>
              Show alert
            </button>
          </div>
        );
      }
      ```

      ```jsx
      // ç”¨ useRef ä¿®æ”¹:
      function Example() {
        const [count, setCount] = useState(0);
        
        //ä½¿ç”¨ useRef
        const countRef = useRef();
        countRef.current = count;
        
        function handleAlertClick() {
          setTimeout(() => {
            alert('You clicked on: ' + countRef.current); //é€šè¿‡ ref è®¿é—® countï¼Œè¯»å–çš„æ˜¯æœ€æ–°å€¼
          }, 3000);
        }
      
        return (
          <div>
            <p>You clicked {count} times</p>
            <button onClick={() => setCount(count + 1)}>
              Click me
            </button>
            <button onClick={handleAlertClick}>
              Show alert
            </button>
          </div>
        );
      }
      ```

    - æ‡’åŠ è½½

      - useRef ä¸åƒ useState é‚£æ ·æ¥æ”¶å‡½æ•°

        ```jsx
        function Image(props) {
          // âš ï¸ IntersectionObserver is created on every render
          const ref = useRef(new IntersectionObserver(onIntersect));
          // ...
        }
        ```

        ```jsx
        function Image(props) {
          const ref = useRef(null);
        
          // âœ… IntersectionObserver is created lazily once
          function getObserver() {
            let observer = ref.current;
            if (observer !== null) {
              return observer;
            }
            let newObserver = new IntersectionObserver(onIntersect);
            ref.current = newObserver;
            return newObserver;
          }
        
          // When you need it, call getObserver()
          // ...
        }
        ```

        

  - useCallback(fn, deps)

    - è¿”å›ä¸€ä¸ªå¸¦ç¼“å­˜çš„ callback

    - ä»…å½“æ‰€éœ€ä¾èµ– deps (æ•°ç»„) ä¸­å…ƒç´ æ”¹å˜æ—¶ï¼Œæ‰æ‰§è¡Œï¼Œå¦åˆ™è¿”å›ç¼“å­˜çš„å€¼

    - ç­‰ä»·äº `useMemo(() => fn, deps)`

    - [`exhaustive-deps`](https://github.com/facebook/react/issues/14920) ESLint

      ```jsx
      // ä½¿ç”¨ Callback Refs, è€Œä¸ç”¨ useRefï¼Œè¿™æ ·å½“ ref æ”¹å˜æ—¶ï¼Œå¯ä»¥è·çŸ¥
      function MeasureExample() {
        const [height, setHeight] = useState(0);
      
        const measuredRef = useCallback(node => {
          if (node !== null) {
            setHeight(node.getBoundingClientRect().height);
          }
        }, []); // [] ç¡®ä¿ ref callback ä¸ä¼šæ”¹å˜ï¼Œre-renders æ—¶ï¼Œä¸ä¼šè¢«é‡å¤è°ƒç”¨æ‰§è¡Œ
      
        return (
          <>
            <h1 ref={measuredRef}>Hello, world</h1>
            <h2>The above header is {Math.round(height)}px tall</h2>
          </>
        );
      }
      ```

      ```jsx
      // æŠ½å–è‡ªå®šä¹‰ Hook
      function MeasureExample() {
        const [rect, ref] = useClientRect();
        return (
          <>
            <h1 ref={ref}>Hello, world</h1>
            {rect !== null &&
              <h2>The above header is {Math.round(rect.height)}px tall</h2>
            }
          </>
        );
      }
      
      function useClientRect() {
        const [rect, setRect] = useState(null);
        const ref = useCallback(node => {
          if (node !== null) {
            setRect(node.getBoundingClientRect());
          }
        }, []);
        return [rect, ref];
      }
      ```

      

  - useMemo(() => fn, deps)

    - è¿”å›ä¸€ä¸ªå¸¦ç¼“å­˜çš„å€¼ï¼Œé¿å…æ¶ˆè€—æ€§èƒ½çš„è®¡ç®—é‡å¤æ‰§è¡Œ

      ```jsx
      const memoizedValue = useMemo(() => computeExpensiveValue(a, b), [a, b]);
      ```

      - ä»…å½“ aï¼Œb æ”¹å˜æ—¶ï¼Œæ‰ä¼šé‡æ–°è°ƒç”¨ computeExpensiveValue
      - æ¯æ¬¡ render æ—¶ï¼Œä¼ ç»™ useMemo çš„å‡½æ•°ä¼šæ‰§è¡Œï¼Œä¸è¦æŠŠä¸€äº›å‰¯ä½œç”¨æ”¾åˆ°é‡Œé¢

    - æ€§èƒ½ä¼˜åŒ–

      ```jsx
      function Parent({ a, b }) {
        // Only re-rendered if `a` changes:
        const child1 = useMemo(() => <Child1 a={a} />, [a]);
        // Only re-rendered if `b` changes:
        const child2 = useMemo(() => <Child2 b={b} />, [b]);
        return (
          <>
            {child1}
            {child2}
          </>
        )
      }
      ```

      

  - useImperativeHandle(ref, createHandle, [deps])

    - å½“ä½¿ç”¨ ref æ¥ç»™çˆ¶ç»„ä»¶æä¾›å®ä¾‹æ—¶ï¼Œç”¨æ¥æä¾›è‡ªå®šä¹‰çš„æ–¹æ³•å±æ€§

    - å°½é‡é¿å…ä½¿ç”¨

    - åº”è¯¥ä¸ forwardRef ä¸€èµ·ä½¿ç”¨

      ```jsx
      function FancyInput(props, ref) {
        const inputRef = useRef();
        useImperativeHandle(ref, () => ({
          focus: () => {
            inputRef.current.focus();
          }
        }));
        return <input ref={inputRef} />;
      }
      FancyInput = forwardRef(FancyInput);
      ```

      ```jsx
      function Parent() {
        const fancyInputRef = useRef();
        return (
          <>
            <FancyInput ref={fancyInputRef} />
            <button onClick={()=>{
                fancyInputRef.current.focus()
            }}>Focus</button>
          </>
        )
      }

      ```




